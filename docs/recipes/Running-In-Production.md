[`one-app-bundler`]: https://github.com/americanexpress/one-app-cli/tree/master/packages/one-app-bundler
[React]: http://reactjs.org/

[üëà Return to Overview](./Recipes.md)

# Running In Production

<!-- TODO: expand on this section -->
One App is battle tested as it has been in use in production within American Express with our most highly trafficked customer facing applications since 2016.

It was built with [The Twelve-Factor App](https://12factor.net/) principles in mind and as such is
highly flexible and independent of its runtime.

One App can be started via docker or if built from source by running `node lib/server/index.js` on your server.

**Contents**
* [Building And Deploying Holocron Modules](#building-and-deploying-holocron-modules)
* [Building and Deploying a Holocron Module Map](#building-and-deploying-a-holocron-module-map)
* [Building One App](#building-one-app)
* [Configuring One App](#configuring-one-app)

## Building And Deploying Holocron Modules

Holocron Modules are [React] components that are bundled by
[`one-app-bundler`]
and are the pieces that make up a One App application instance.

Running [`one-app-bundler`] on a module builds and packages the module's source code into static assets
that can to be deployed to a CDN. It expects `./src/index.js` to export a [React] component and
creates a `build` directory as its output.

Input:
```
root
|‚îÄ‚îÄ src
|   ‚îî‚îÄ‚îÄ index.js
‚îî‚îÄ‚îÄ package.json
```


Output:
```
build
‚îî‚îÄ‚îÄ 1.0.0
    ‚îú‚îÄ‚îÄ <moduleName>.browser.js
    ‚îú‚îÄ‚îÄ <moduleName>.legacy.browser.js
    ‚îú‚îÄ‚îÄ <moduleName>.node.js
    ‚îî‚îÄ‚îÄ en-us
        ‚îú‚îÄ‚îÄ <moduleName>.json
        ‚îú‚îÄ‚îÄ integration.json
        ‚îî‚îÄ‚îÄ qa.json
```

`en-us` contains the language packs used for internationalization for the `en-US` locale. As this is
an example only `en-us` is shown but in your module you may have as many or few locales as needed.

`<moduleName>.browser.js` is the [modern browser bundle](https://github.com/americanexpress/babel-preset-amex/blob/master/browserlist.js#L15).

`<moduleName>.legacy.browser.js` is the [legacy browser bundle](https://github.com/americanexpress/babel-preset-amex/blob/master/browserlist.js#L24).

`<moduleName>.node.js` is the server bundle.

These bundles are used in One App depending on the environment your module is running in. For example
if One App detects that your module's bundle is being requested by an older browser then
the `<moduleName>.legacy.browser.js` bundle will be served which includes polyfills and the needed
transpilation for that browser. Otherwise it will serve the potentially leaner `<moduleName>.browser.js`
or the `<moduleName>.node.js` bundle when running on the server.

*Note that if you are making use of code splitting via dynamic imports in your module there may be more chunks in your `build` directory.*

One App has no opinion on where module bundles are deployed to, the only thing to keep in mind is
that all the assets for a given module must be kept together when deployed, i.e. the file structure
generated by [`one-app-bundler`] must not be modified. This is because the bundles rely on this
structure for knowing where to look for the lang packs. To see examples of how to deploy modules to certain hosting platforms, take a look at our documentation on [deploying modules](./Deploying-Modules.md).

## Building and Deploying a Holocron Module Map

In order for One App to use a module two things need to happen:

1. The module's static assets must be deployed to a static server.
2. A Holocron module map must be created / updated with the module's metadata and hosted on a static server.

A Holocron module map is what tells One App what Modules it should load and where to find them.

It is what allows for Holocron modules to be loaded and used by One App without requiring a One App
deployment or restart. When One App is started on a server it reads from the `HOLOCRON_MODULE_MAP_URL`
to find out where it should fetch the module map from and then periodically polls this module
map and adds / removes / updates its internal module registry to match any changes to it.

Ultimately a Holocron Module Map is a JSON object of the following shape:

```json
{
  "clientCacheRevision": "123",
  "modules": {
    "<moduleName>": {
      "browser": {
        "integrity": "sha256-ws6s6vTApdkif2pOfsYOGwdfE9LurZ7Bwq4Olvomrf8= sha384-CLKgejOPhJjRFoUKxLRGeuH09z376SvuTfnWw8IhnShureZQmhzf+GoWGQeA++WU",
        "url": "https://example.com/modules/<moduleName>/0.0.0/<moduleName>.browser.js"
      },
      "legacyBrowser": {
        "integrity": "sha256-0wTIJNLsNA9kxoiTPpH0xcseRA+2MezF1r0cdhxx1X0= sha384-jrl8W8VHVqk42r//1LDOYgXG8KIIeBrYMRsEj8bXBEUBNq1X+PUr4XtqGubeoJ36",
        "url": "https://example.com/modules/<moduleName>/0.0.0/<moduleName>.legacy.browser.js"
      },
      "node": {
        "integrity": "sha256-LqwNreqEhpaXBRSmhW8/L1MpxcyBsoMwC4IKj8MSFTE= sha384-QLDAyAeq11y9llJhMXd36WwiGg49uJX23EtgaKsCVV83fUJ0rLrswb8V9IoeRIB2",
        "url": "https://example.com/modules/<moduleName>/0.0.0/<moduleName>.node.js"
      }
    }
  }
}
```

The `clientCacheRevision` property is used to cache bust all module bundles. This works because its value is appended
to each module asset request from One App.

The `modules` property contains module objects containing the URL and
[subresource integrity](https://developer.mozilla.org/en-US/docs/Web/Security/Subresource_Integrity)
information for each of the module's assets. There are three assets created by
[`one-app-bundler`] for each module that need to be referenced here for One App to use, `browser`,
`legacyBrowser`, and `node`. The value for the
[`integrity` property](https://developer.mozilla.org/en-US/docs/Web/Security/Subresource_Integrity)
is generated by [`one-app-bundler`] and can be found in the `bundle.integrity.manifest.json` file
within the module's root directory after running [`one-app-bundler`] on it.

Your CI / CD process can generate the module map and update it as modules are added / updated / removed
and then publish the file to a static server. Just like with module assets One App does not have an
opinion of where the module map is published, it only cares that the module map is accessible shaped
correctly.

## Building One App

You can build the One App [Docker](https://www.docker.com/) image and run it in your cloud / data center of choice:

```bash
git clone https://github.com/americanexpress/one-app.git
cd one-app
docker build .
```

Or you can build from source which creates your server side assets at `./lib` and your client
side assets to be deployed to a CDN at `./build`.

```bash
git clone https://github.com/americanexpress/one-app.git
cd one-app
NODE_ENV=development npm ci
NODE_ENV=production npm run build
```

## Configuring One App

One App is configured via [environment variables](#). There are a few
environment variables that are required for One App to start up including the one used to let One App
know where to fetch a module map from as described above.

[‚òùÔ∏è Return To Top](#running-in-production)
